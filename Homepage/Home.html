<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="Home.css" />
  <link rel="icon" type="img/jpg" href="../logo.png" />
  <title>TaskTavern Home</title>
</head>

<body>
  <div class="fadeaway">
    <center>
      <h1><img src="../TaskTavern.png"></h1>
    </center>

    <!-- Character Preview Box on Home Page -->
    <div class="homeCharacterBox">
      <div id="homeCharPreview"></div>
    </div>

    <script>
      if (!sessionStorage.getItem("loggedIn")) {
        alert("Access denied. Please log in first.");
        window.location.href = "../Index.html";
      }
    </script>

    <div class="main">

      <button class="Pfp" id="displayNameBtn" onclick="location.href='Profile/sex.html'">
        <div class="Profile">
          <img src="../ButtonIcons/profile.png" alt="Profile">
          <span id="homeUsername" class="usernameDisplay"></span>
        </div>
      </button>



      <div class="signout">
        <a href="../index.html">Log Out</a>
      </div>
    </div>

    <button class="TaskButt" id="TaskButt"><img src="../ButtonIcons/schedule.png"></button>
    <div class="sidepnnl" id="sidepnnl">
      <button id="close-sidebar" class="closebutt"><img src="../ButtonIcons/close.png"></button>

      <div class="total-points-box">
        <h3>Total Points</h3>
        <p id="totalPointsDisplay">0</p>
      </div>

      <ul class="List">
        <li><button class="mon" onclick="location.href='TaskDay/monday/mon.html'"><img
              src="TaskDay/Buttons/MONDAY.png"></button></li>
        <li><button class="tue" onclick="location.href='TaskDay/tuesday/tue.html'"><img
              src="TaskDay/Buttons/TUESDAY.png"></button></li>
        <li><button class="wed" onclick="location.href='TaskDay/wednesday/wed.html'"><img
              src="TaskDay/Buttons/WEDNESDAY.png"></button></li>
        <li><button class="thurs" onclick="location.href='TaskDay/thurdays/thurs.html'"><img
              src="TaskDay/Buttons/THURSDAY.png"></button></li>
        <li><button class="fri" onclick="location.href='TaskDay/friday/fri.html'"><img
              src="TaskDay/Buttons/FRIDAY.png"></button></li>
        <li><button class="sat" onclick="location.href='TaskDay/saturday/sat.html'"><img
              src="TaskDay/Buttons/SATURDAY.png"></button></li>
        <li><button class="sun" onclick="location.href='TaskDay/sunday/sun.html'"><img
              src="TaskDay/Buttons/SUNDAY.png"></button></li>
      </ul>
    </div>

    <div class="Task" id="task-compilation-area">

    </div>

  </div>

  <script src="sidebar.js"></script>
  <script src="taskCompiler.js"></script>

  <script>
    (function () {
      const currentUser = sessionStorage.getItem("currentUser");
      if (!currentUser) return;

      const previewBox = document.getElementById("homeCharPreview");

      function loadPreview() {
        // clear existing preview
        previewBox.innerHTML = "";

        const gender = localStorage.getItem(`${currentUser}_gender`) || "male";

        // choose key based on gender
        const key = gender === "female"
          ? `${currentUser}_character_female`
          : `${currentUser}_character`;

        const data = JSON.parse(localStorage.getItem(key) || "{}");

        // ==============================
        // BASE BODY â€“ separated male/female
        // ==============================
        const base = document.createElement("img");

        if (gender === "female") {
          base.src = "Customization/Body F.png";
          base.className = "base female-base";  // female gets special class
        } else {
          base.src = "Customization/Body M.png";
          base.className = "base male-base";    // male gets own class
        }

        base.style.zIndex = "0";
        previewBox.appendChild(base);

        // ==============================
        // ADD LAYERS (shirt, pants, hat)
        // ==============================
        function addLayer(src, className, zIndex) {
          if (!src) return;
          const img = document.createElement("img");
          img.src = src;
          img.className = className;
          img.style.zIndex = zIndex;
          previewBox.appendChild(img);
        }

        addLayer(data.pants, data.pantsClass, 2);
        addLayer(data.shirt, data.shirtClass, 3);
        addLayer(data.hat, data.hatClass, 4);
      }

      // initial run
      loadPreview();

      // storage updates from other tabs
      window.addEventListener("storage", (e) => {
        if ([`${currentUser}_character`, `${currentUser}_character_female`, `${currentUser}_gender`].includes(e.key)) {
          loadPreview();
        }
      });

      // custom event updates from same tab
      window.addEventListener("characterUpdated", loadPreview);

      // reload when returning to tab
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) loadPreview();
      });
    })();
  </script>

  <script src="userdata.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const currentUser = sessionStorage.getItem("currentUser");
      if (!currentUser) return;

      const usernameSpan = document.getElementById("homeUsername");

      // detect gender so it loads correct character file
      const gender = localStorage.getItem(currentUser + "_gender") || "male";
      const key = gender === "female"
        ? currentUser + "_character_female"
        : currentUser + "_character";

      const data = JSON.parse(localStorage.getItem(key) || "{}");

      usernameSpan.textContent = data.username || "Guest";
    });
  </script>


  <script>
    (function () {
      // Run after DOM ready
      function initTotalPointsBox() {
        // Use a private variable name to avoid global collisions
        const __tt_currentUser = sessionStorage.getItem("currentUser");
        if (!__tt_currentUser) {
          // Safe redirect: use same-case filename you have in your project
          window.location.href = "../index.html";
          return;
        }

        // Days to sum
        const dayPrefixes = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
        let totalPoints = 0;

        for (const day of dayPrefixes) {
          const key = `${__tt_currentUser}_${day}_totalPoints`;
          // parseInt with fallback; guard against non-numeric values
          const pts = parseInt(localStorage.getItem(key), 10);
          totalPoints += Number.isFinite(pts) ? pts : 0;
        }

        // Set the value only if the element exists
        const el = document.getElementById("totalPointsDisplay") || document.getElementById("points") || null;
        if (el) {
          el.textContent = totalPoints;
        } else {
          // Optional: create the small badge in the sidebar if it's missing
          const side = document.getElementById("sidepnnl");
          if (side) {
            const box = document.createElement("div");
            box.className = "total-points-box";
            box.innerHTML = `<h3>Total Points</h3><p id="totalPointsDisplay">${totalPoints}</p>`;
            const firstUl = side.querySelector(".List");
            side.insertBefore(box, firstUl);
          }
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initTotalPointsBox);
      } else {
        initTotalPointsBox();
      }
    })();
  </script>




</body>

</html>